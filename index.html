<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーガーショップマップ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link 
        rel="stylesheet" 
        href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <style>
        body, html { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; }
        /* セレクトボックスを地図上に固定表示 */
        #shopFilter {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 5px;
            background: white;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <select id="shopFilter">
        <option value="all">全て</option>
        <option value="マクドナルド">マクドナルド</option>
        <option value="モスバーガー">モスバーガー</option>
        <option value="バーガーキング">バーガーキング</option>
    </select>
    <div id="map"></div>

    <div id="splash-screen" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    ">
        <h1 style="font-size: 3rem; font-weight: bold; color: #ffffff;">
            <img src="./img/hamburger.png" alt="Quake Guard Logo" style="width: 100px; height: 100px; display: block; margin: 0 auto; filter: brightness(0) invert(1); border-radius: 50%;">
            俺のハンバーガーマップ<br>
            <span style="font-size: 1.5rem; color: #f7f7f7; display: block; text-align: center;">My hamburger map</span>
        </h1>
    </div>

    <script>
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');
            setTimeout(() => {
                splash.style.transition = 'opacity 1s';
                splash.style.opacity = '0';
                setTimeout(() => splash.remove(), 1000);
            }, 1000);
        });
    </script>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        // 各チェーンごとのJSONファイルを読み込んで統合する
        let shops = [];

        // ファイル名とチェーン名の対応
        const shopSources = [
            { url: "./static/Mcd.json", chain: "マクドナルド" },
            { url: "./static/Mos.json", chain: "モスバーガー" },
            { url: "./static/King.json", chain: "バーガーキング" }
        ];

        // カスタムアイコン
        const mcdIcon = L.divIcon({
            html: `<div style="
                width:40px;
                height:40px;
                border-radius:50%;
                overflow:hidden;
                border:2px solid #fff;
                box-shadow:0 0 4px #888;
                background:#fff;
                display:flex;
                align-items:center;
                justify-content:center;
            ">
                <img src="./img/mcd_icon.png" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
            </div>`,
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -36],
            className: ""
        });

        const mosIcon = L.divIcon({
            html: `<div style="
                width:40px;
                height:40px;
                border-radius:50%;
                overflow:hidden;
                border:2px solid #fff;
                box-shadow:0 0 4px #888;
                background:#fff;
                display:flex;
                align-items:center;
                justify-content:center;
            ">
                <img src="./img/mos_icon.jpg" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
            </div>`,
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -36],
            className: ""
        });

        const bkIcon = L.divIcon({
            html: `<div style="
                width:40px;
                height:40px;
                border-radius:50%;
                overflow:hidden;
                border:2px solid #fff;
                box-shadow:0 0 4px #888;
                background:#fff;
                display:flex;
                align-items:center;
                justify-content:center;
            ">
                <img src="./img/king_icon.png" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
            </div>`,
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -36],
            className: ""
        });

        // マップ作成とショップマーカー管理用のレイヤーグループ変数
        let map, shopLayerGroup;

        // ショップを更新して表示する関数
        function updateShops(filter) {
            if (!shopLayerGroup) return;
            shopLayerGroup.clearLayers();
            shops.forEach(shop => {
                if (filter === "all" || shop.chain === filter) {
                    let options = {};
                    if (shop.chain === "マクドナルド") {
                        options.icon = mcdIcon;
                    } else if (shop.chain === "モスバーガー") {
                        options.icon = mosIcon;
                    } else if (shop.chain === "バーガーキング") {
                        options.icon = bkIcon;
                    }
                    L.marker([shop.lat, shop.lng], options)
                        .addTo(shopLayerGroup)
                        .bindPopup(`<strong>${shop.name}</strong><br>${shop.chain}`);
                }
            });
        }

        // セレクトボックスの変更イベント設定
        document.getElementById("shopFilter").addEventListener("change", function() {
            updateShops(this.value);
        });

        // 複数JSONを読み込んで統合
        function loadAllShops(callback) {
            let loaded = 0;
            shopSources.forEach(source => {
                fetch(source.url)
                    .then(res => res.json())
                    .then(data => {
                        // 各JSONは配列で、各要素にchain名を付与
                        data.forEach(shop => shop.chain = source.chain);
                        shops = shops.concat(data);
                    })
                    .catch(() => {
                        // 読み込み失敗時は何もしない
                    })
                    .finally(() => {
                        loaded++;
                        if (loaded === shopSources.length) callback();
                    });
            });
        }

        // ユーザーの現在地を取得してマップの初期化
        function initializeMap(lat, lng, currentLocationText) {
            map = L.map('map').setView([lat, lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // 現在地マーカー
            L.marker([lat, lng])
                .addTo(map)
                .bindPopup(currentLocationText)
                .openPopup();

            // ショップマーカー用のレイヤーグループ
            shopLayerGroup = L.layerGroup().addTo(map);
            updateShops(document.getElementById("shopFilter").value);
        }

        // 初期化を遅延して、shopsが揃ってから実行
        window.addEventListener("DOMContentLoaded", function() {
            loadAllShops(() => {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    initializeMap(lat, lng, "あなたの現在地");
                }, function(error) {
                    // ジオロケーション取得失敗時：東京を初期位置に設定
                    const lat = 35.84463394318977;
                    const lng = 139.9541698621203;
                    initializeMap(lat, lng, "デフォルト位置：東京");
                });
            });
        });
    </script>
</body>
</html>